name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags, e.g. v1.0.0

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Install Playwright browsers
      run: |
        uv run playwright install chromium

    - name: Build executable
      shell: bash
      run: |
        # Use spec file for optimized build
        uv run pyinstaller register.spec
        
        # Rename output to include OS name
        if [ "${{ runner.os }}" == "Windows" ]; then
          mv dist/TraeAccountCreator.exe dist/TraeAccountCreator-${{ runner.os }}.exe
        else
          mv dist/TraeAccountCreator dist/TraeAccountCreator-${{ runner.os }}
        fi

    - name: Prepare Release Bundle
      shell: bash
      run: |
        # Create a directory for the bundle
        mkdir -p bundle/TraeAccountCreator-${{ runner.os }}
        
        # Copy executable
        if [ "${{ runner.os }}" == "Windows" ]; then
          cp dist/TraeAccountCreator-${{ runner.os }}.exe bundle/TraeAccountCreator-${{ runner.os }}/TraeAccountCreator.exe
        else
          cp dist/TraeAccountCreator-${{ runner.os }} bundle/TraeAccountCreator-${{ runner.os }}/TraeAccountCreator
        fi
        
        # Copy .env.example
        cp .env.example bundle/TraeAccountCreator-${{ runner.os }}/.env.example
        
        # Locate and copy Playwright browsers (Optimized)
        echo "Locating Chromium..."
        # Use Python to find the exact installed chromium folder
        CHROMIUM_DIR=$(uv run python -c "from playwright.sync_api import sync_playwright; import os, pathlib; p=sync_playwright().start(); path=p.chromium.executable_path; p.stop(); path=pathlib.Path(path); found=[p for p in [path, *path.parents] if p.name.startswith('chromium-')]; print(found[0].as_posix() if found else '')")
        
        echo "Found Chromium at: $CHROMIUM_DIR"
        
        if [ -z "$CHROMIUM_DIR" ]; then
          echo "Error: Could not find chromium directory."
          exit 1
        fi

        # Copy only the specific chromium version
        mkdir -p bundle/TraeAccountCreator-${{ runner.os }}/browsers
        cp -r "$CHROMIUM_DIR" bundle/TraeAccountCreator-${{ runner.os }}/browsers/
        
        # Remove ffmpeg to reduce size (not needed for this app)
        echo "Removing ffmpeg to save space..."
        find bundle/TraeAccountCreator-${{ runner.os }}/browsers -name "*ffmpeg*" -delete
        
        # Create Archives
        cd bundle
        
        # 1. Full/Portable Version (with browsers)
        if [ "${{ runner.os }}" == "Windows" ]; then
          if command -v 7z >/dev/null 2>&1; then
            7z a ../TraeAccountCreator-${{ runner.os }}-Portable.zip TraeAccountCreator-${{ runner.os }}
          else
            powershell -Command "Compress-Archive -Path 'TraeAccountCreator-${{ runner.os }}' -DestinationPath '../TraeAccountCreator-${{ runner.os }}-Portable.zip'"
          fi
          echo "ARCHIVE_PORTABLE=TraeAccountCreator-${{ runner.os }}-Portable.zip" >> $GITHUB_ENV
        else
          tar -czf ../TraeAccountCreator-${{ runner.os }}-Portable.tar.gz TraeAccountCreator-${{ runner.os }}
          echo "ARCHIVE_PORTABLE=TraeAccountCreator-${{ runner.os }}-Portable.tar.gz" >> $GITHUB_ENV
        fi
        
        # 2. Lite Version (without browsers)
        # Remove browsers folder from the bundle temporarily to zip it
        rm -rf TraeAccountCreator-${{ runner.os }}/browsers
        
        if [ "${{ runner.os }}" == "Windows" ]; then
          if command -v 7z >/dev/null 2>&1; then
            7z a ../TraeAccountCreator-${{ runner.os }}-Lite.zip TraeAccountCreator-${{ runner.os }}
          else
            powershell -Command "Compress-Archive -Path 'TraeAccountCreator-${{ runner.os }}' -DestinationPath '../TraeAccountCreator-${{ runner.os }}-Lite.zip'"
          fi
          echo "ARCHIVE_LITE=TraeAccountCreator-${{ runner.os }}-Lite.zip" >> $GITHUB_ENV
        else
          tar -czf ../TraeAccountCreator-${{ runner.os }}-Lite.tar.gz TraeAccountCreator-${{ runner.os }}
          echo "ARCHIVE_LITE=TraeAccountCreator-${{ runner.os }}-Lite.tar.gz" >> $GITHUB_ENV
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TraeAccountCreator-${{ runner.os }}
        path: |
          ${{ env.ARCHIVE_PORTABLE }}
          ${{ env.ARCHIVE_LITE }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          TraeAccountCreator-Windows/*
          TraeAccountCreator-Linux/*
          TraeAccountCreator-macOS/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
